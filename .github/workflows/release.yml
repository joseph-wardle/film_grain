name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  BIN_NAME: viewer

jobs:
  build-and-release:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            archive: tar.xz
            bin_suffix: ""
          - os: macos-13
            target: x86_64-apple-darwin
            archive: tar.xz
            bin_suffix: ""
          - os: macos-latest
            target: aarch64-apple-darwin
            archive: tar.xz
            bin_suffix: ""
          # Windows
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive: zip
            bin_suffix: ".exe"

    env:
      VERSION: ${{ github.ref_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Install musl tools (Linux only)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package
        shell: bash
        run: |
          set -euo pipefail

          BIN_PATH="target/${{ matrix.target }}/release/${BIN_NAME}${{ matrix.bin_suffix }}"
          echo "Using binary at: $BIN_PATH"
          ls "$BIN_PATH"

          STAGE="dist-${{ matrix.target }}"
          rm -rf "$STAGE"
          mkdir "$STAGE"

          cp "$BIN_PATH" "$STAGE/${BIN_NAME}${{ matrix.bin_suffix }}"
          [ -f README.md ] && cp README.md "$STAGE/"
          [ -f LICENSE ] && cp LICENSE "$STAGE/"

          ARCHIVE_NAME="${BIN_NAME}-${VERSION}-${{ matrix.target }}.${{ matrix.archive }}"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> "$GITHUB_ENV"

          if [[ "${{ matrix.archive }}" == "zip" ]]; then
            (cd "$STAGE" && zip "../$ARCHIVE_NAME" ./*)
          else
            (cd "$STAGE" && tar -cJf "../$ARCHIVE_NAME" ./*)
          fi

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARCHIVE_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
